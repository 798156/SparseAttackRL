#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""快速RSA共模攻击求解"""

def long_to_bytes(n):
    """将长整数转换为字节串"""
    if n == 0:
        return b'\x00'
    bytes_array = []
    while n > 0:
        bytes_array.append(n & 0xff)
        n >>= 8
    return bytes(reversed(bytes_array))

def egcd(a, b):
    """扩展欧几里得算法"""
    if b == 0:
        return a, 1, 0
    else:
        g, x, y = egcd(b, a % b)
        return g, y, x - (a // b) * y

def mod_inverse(a, m):
    """计算模逆"""
    g, x, _ = egcd(a, m)
    if g != 1:
        raise Exception('模逆不存在')
    return x % m

# 给定参数
n = 12184620342604321526236147921176689871260702807639258752158298414126076615130224253248632789995209263378074151299166903216279276546198828352880417707078853010887759267119069971739321905295081485027018480973993441393590030075971419165113599211569178425331802782763120185350392723844716582476742357944510728860535408085789317844446495987195735585533277358245562877243064161565448407188900804528695784565011073374273835326807616704068806996983861885772305191259029021518998160545972629938341341148477795894816345752396040127286263780418335699743896454197151019898505844519753453115300227481242993291336748858733029540609
e1 = 65537
e2 = 10001
c1 = 902947871638340144585350496607905036788917988784297938051712515029419473301205843372041904115813361402310512640716508455953201343091183980022416880886523265909139556951175072940441586166669057233430247014907124872576782948489940428513680356381769358116956570193102584168134758031000460513472898624075765670452482015562555449322262139576088011030490086784087285869959810062075648470122232452663599195404333292792928816934802064740144937473749408450501803510475933273448208685792400696632919950948832464784621694657179199125876564156360048730797653060931844444935302553732964065897065735427838601696506594726842758656
c2 = 7024079443689213821451191616762957236018704240049119768827190246286227366906772824421534943039282921384333899446122799252327963055365970065258371710141470872948613397123358914507497871585713222863470875497667604127210508840915183968145267083193773724382523920130152399270957943228022350279379887455019966651166356404967621474933206809521046480962602160962854745553005978607776790079518796651707745342923714121497001171456582586327982922261473553814594384196824815090185841526000247291514943042643385984600122463395695871306301585799490389353720773152762256126676456786420058282912965520064317739998211921049808590504

print("正在计算...")

# 扩展欧几里得算法求解
gcd, s, t = egcd(e1, e2)
print(f"gcd(e1, e2) = {gcd}")
print(f"系数: s = {s}, t = {t}")

# 处理负数系数
if s < 0:
    s = -s
    c1 = mod_inverse(c1, n)
if t < 0:
    t = -t
    c2 = mod_inverse(c2, n)

# 计算明文
m = (pow(c1, s, n) * pow(c2, t, n)) % n

print(f"\n明文(十进制): {m}")
print(f"明文(十六进制): {hex(m)}")

# 转换为字节串
plaintext = long_to_bytes(m)
print(f"\n明文(字节): {plaintext}")

# 尝试解码
try:
    result = plaintext.decode('utf-8')
    print(f"\n✓ 解密结果: {result}")
except:
    try:
        result = plaintext.decode('ascii')
        print(f"\n✓ 解密结果: {result}")
    except:
        print(f"\n解密结果(原始): {plaintext}")

# 验证
print(f"\n验证 c1: {pow(m, e1, n) == c1}")
print(f"验证 c2: {pow(m, e2, n) == c2}")


